# HFT Bot Mechanics & Configuration

Этот документ описывает текущие механики бота, их логику работы и параметры, которые можно настроить (в коде).

## 1. Динамический Спред (Dynamic Spread)
Спред адаптируется к состоянию рынка, чтобы защитить маркет-мейкера от токсичных потоков и волатильности.

**Логика:**
Итоговый спред выбирается как **максимум** из двух компонентов:
1.  **TPS Spread (Скорость тиков):**
    *   Если рынок спокойный (TPS < 20) -> Спред **0.4%**.
    *   Если рынок "штормит" (TPS > 100) -> Спред **1.0%**.
    *   В промежутке значение линейно интерполируется.
2.  **Shock Spread (Реакция на гэпы):**
    *   Если цена мгновенно прыгает (гэп), спред расширяется моментально.
    *   Формула: `ИзменениеЦены * 4.0`.
    *   Пример: Прыжок на 0.2% даст добавку 0.8% к спреду.

**Параметры (в `market_maker.rs`):**
- `min_tps`: 20.0 (Начало расширения)
- `max_tps`: 100.0 (Максимальное расширение)
- `min_spread`: 0.004 (0.4%)
- `max_spread`: 0.010 (1.0%)
- `shock_multiplier`: 4.0 (Коэффициент реакции на гэп)

---

## 2. Детектор Стен (Liquidity Wall Detection)
Бот сканирует стакан, чтобы использовать чужую ликвидность как защиту ("стену").

**Логика:**
1.  Сканируем топ-20 уровней стакана (Bids и Asks).
2.  Ищем уровень с объемом выше порога (`wall_threshold`).
3.  Если стена найдена и она находится в выгодной зоне (ближе к спрэду, но не пересекает Mid Price):
    *   Бот ставит свой ордер **на 1 тик (0.01) перед стеной**.
    *   Это позволяет "спрятаться" за крупным игроком и получить исполнение первым, имея страховку сзади.

**Параметры:**
- `wall_threshold`: 1000.0 (Объем лотов, считающийся "стеной")
- `tick_size`: 0.01

---

## 3. Фильтрация и Триггеры (Triggers & Filtering)
Чтобы не спамить API и не ловить "пилы", бот фильтрует моменты для перестановки ордеров.

**Логика:**
1.  **Batch Detection (Атомарность):**
    *   Если биржа шлет пачку обновлений с **одним timestamp** (одно событие сведения), бот игнорирует промежуточные состояния и реагирует только на финальную цену пачки.
2.  **Price Trigger:**
    *   Ордера переставляются, ТОЛЬКО если цена изменилась более чем на **0.1%** от прошлой перестановки.
3.  **Rate Limiter (Буфер):**
    *   Защитный интервал **100 мс** между перестановками ордеров (макс 10 req/s), даже если цена летит.
4.  **Heartbeat:**
    *   Если цена стоит на месте, ордера обновляются принудительно раз в **30 секунд** (чтобы биржа не считала нас мертвыми).

**Параметры:**
- `change_threshold`: 0.001 (0.1%)
- `min_interval`: 100ms
- `heartbeat`: 30s

---

## 4. Управление Позицией (Position Management)
Логика выхода из сделки.

**Логика:**
1.  **Take Profit:** Закрытие при прибыли **+0.3%**.
2.  **Time Limit (Stop Time):** Если позиция убыточна и удерживается дольше **3 секунд**, она закрывается принудительно (избегание "залипания" в убытке).
3.  **Cancel All:** Перед закрытием позиции бот вызывает `CancelAll`, чтобы гарантированно убрать все лимитки с пути.

**Параметры:**
- `take_profit`: 1.003 (+0.3%)
- `max_hold_time`: 3s

---

## 5. Защита и Восстановление (Safety & Recovery)
Защита от технических сбоев.

**Логика:**
1.  **API Rate Limit Protection:**
    *   При получении ошибки `10006` (Too many visits) бот засыпает на **10 секунд**.
2.  **Sync Repair:**
    *   При ошибках `110017` (ReduceOnly failed) или `10404` бот принудительно сбрасывает локальную позицию в 0, разрывая цикл ошибок.
